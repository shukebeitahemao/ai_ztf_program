<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIËÅäÂ§©Âä©Êâã</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f7f7f8;
            height: 100vh;
            overflow: hidden;
        }

        .chat-container {
            display: flex;
            height: 100vh;
        }

        /* ‰∏ªËÅäÂ§©Âå∫Âüü */
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: white;
        }

        /* ËÅäÂ§©Â§¥ÈÉ® */
        .chat-header {
            padding: 16px 24px;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .header-buttons {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 8px 16px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn:hover {
            background-color: #f3f4f6;
        }

        .btn.danger {
            color: #dc2626;
            border-color: #dc2626;
        }

        .btn.danger:hover {
            background-color: #fef2f2;
        }

        /* ÈÄâÈ°πÂå∫Âüü */
        .story-options {
            padding: 16px 24px;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .option-label {
            font-size: 14px;
            color: #6b7280;
            margin-right: 8px;
        }

        .option-btn {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .option-btn.active {
            background-color: #10b981;
            color: white;
            border-color: #10b981;
        }

        .option-btn:hover:not(.active) {
            background-color: #f3f4f6;
        }

        /* ËÅäÂ§©Ê∂àÊÅØÂå∫Âüü */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            display: flex;
            gap: 12px;
            max-width: 80%;
            animation: fadeIn 0.3s ease-in;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .message.user .message-avatar {
            background-color: #10b981;
        }

        .message.system .message-avatar {
            background-color: #6366f1;
        }

        .message-content {
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background-color: #10b981;
            color: white;
        }

        .message.system .message-content {
            background-color: #f3f4f6;
            color: #333;
        }

        /* ÊâìÂ≠óÊú∫ÊïàÊûú */
        .message.typing .message-content::after {
            content: '|';
            animation: blink 1s infinite;
            color: #10b981;
            font-weight: bold;
        }

        @keyframes blink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0;
            }
        }

        /* ËæìÂÖ•Âå∫Âüü */
        .chat-input {
            padding: 24px;
            border-top: 1px solid #e5e5e5;
            background-color: white;
        }

        .input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            position: relative;
        }

        .input-field {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            resize: none;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.5;
            max-height: 120px;
            min-height: 44px;
        }

        .input-field:focus {
            outline: none;
            border-color: #10b981;
        }

        .send-btn {
            padding: 12px 24px;
            background-color: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .send-btn:hover:not(:disabled) {
            background-color: #059669;
        }

        .send-btn:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
        }

        /* ËØ≠Èü≥ÊåâÈíÆÊ†∑Âºè */
        .voice-btn {
            padding: 12px;
            background-color: #6366f1;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
            min-width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-btn:hover:not(:disabled) {
            background-color: #4f46e5;
        }

        .voice-btn:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
        }

        .voice-btn.recording {
            background-color: #dc2626;
            animation: pulse 1.5s infinite;
        }

        .voice-btn.recording:hover {
            background-color: #b91c1c;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        /* ËØ≠Èü≥Áä∂ÊÄÅÊèêÁ§∫ */
        .voice-status {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #374151;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 100;
        }

        .voice-status::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #374151;
        }

        /* ÂéÜÂè≤ËÆ∞ÂΩï‰æßËæπÊ†è */
        .history-sidebar {
            width: 320px;
            background-color: white;
            border-left: 1px solid #e5e5e5;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .new-chat-btn {
            padding: 6px 12px;
            background-color: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
        }

        .new-chat-btn:hover {
            background-color: #059669;
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .history-group {
            margin-bottom: 16px;
        }

        .group-title {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            padding: 8px 12px;
            margin-bottom: 4px;
        }

        .history-item {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            border: 1px solid transparent;
        }

        .history-item:hover {
            background-color: #f3f4f6;
        }

        .history-item.active {
            background-color: #ecfdf5;
            border-color: #10b981;
        }

        .history-abstract {
            font-size: 14px;
            color: #333;
            margin-bottom: 4px;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .history-time {
            font-size: 12px;
            color: #6b7280;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6b7280;
            padding: 40px;
            text-align: center;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-size: 14px;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #e5e5e5;
            border-top: 2px solid #10b981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .history-sidebar {
                display: none;
            }

            .chat-messages {
                padding: 16px;
            }

            .message {
                max-width: 90%;
            }
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="chat-container">
            <!-- ‰∏ªËÅäÂ§©Âå∫Âüü -->
            <div class="main-chat">
                <!-- ËÅäÂ§©Â§¥ÈÉ® -->
                <div class="chat-header">
                    <div class="chat-title">AIËÅäÂ§©Âä©Êâã</div>
                    <div class="header-buttons">
                        <button class="btn" @click="clearChat">Ê∏ÖÁ©∫</button>
                        <button class="btn danger" @click="forgetSession" :disabled="!currentSessionId">ÂøòËÆ∞</button>
                    </div>
                </div>

                <!-- ÈÄâÈ°πÂå∫Âüü -->
                <div class="story-options">
                    <span class="option-label">ÈÄâÊã©Ê®°Âºè:</span>
                    <button v-for="option in storyOptions" :key="option" class="option-btn"
                        :class="{ active: selectedStoryType === option }" @click="toggleStoryType(option)">
                        {{ option }}
                    </button>
                </div>

                <!-- ËÅäÂ§©Ê∂àÊÅØÂå∫Âüü -->
                <div class="chat-messages" ref="messagesContainer">
                    <div v-if="messages.length === 0" class="empty-state">
                        <div class="empty-icon">üí¨</div>
                        <div>ÂºÄÂßãÊñ∞ÁöÑÂØπËØùÂêßÔºÅ</div>
                    </div>
                    <div v-for="message in messages" :key="message.id" class="message"
                        :class="[message.type, { typing: message.isTyping }]">
                        <div class="message-avatar">
                            {{ message.type === 'user' ? 'Êàë' : 'AI' }}
                        </div>
                        <div class="message-content">{{ message.content }}</div>
                    </div>
                    <div v-if="isLoading" class="loading">
                        <div class="spinner"></div>
                        AIÊ≠£Âú®ÊÄùËÄÉ‰∏≠...
                    </div>
                </div>

                <!-- ËæìÂÖ•Âå∫Âüü -->
                <div class="chat-input">
                    <div class="input-container">
                        <!-- ËØ≠Èü≥Áä∂ÊÄÅÊèêÁ§∫ -->
                        <div v-if="voiceStatus" class="voice-status">{{ voiceStatus }}</div>

                        <textarea v-model="inputMessage" class="input-field" placeholder="ËæìÂÖ•ÊÇ®ÁöÑÊ∂àÊÅØÊàñÁÇπÂáªËØ≠Èü≥ÊåâÈíÆ..."
                            @keydown.enter.prevent="sendMessage" @input="autoResize" ref="inputField"></textarea>

                        <!-- ËØ≠Èü≥ÊåâÈíÆ -->
                        <button class="voice-btn" :class="{ recording: isRecording }" @click="toggleAudioRecording"
                            :disabled="isLoading || !recordingSupported" :title="isRecording ? 'ÁÇπÂáªÂÅúÊ≠¢ÂΩïÈü≥' : 'ÁÇπÂáªÂºÄÂßãÂΩïÈü≥'">
                            {{ isRecording ? 'üõë' : 'üé§' }}
                        </button>

                        <button class="send-btn" @click="sendMessage" :disabled="!inputMessage.trim() || isLoading">
                            ÂèëÈÄÅ
                        </button>
                    </div>
                </div>
            </div>

            <!-- ÂéÜÂè≤ËÆ∞ÂΩï‰æßËæπÊ†è -->
            <div class="history-sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-title">ËÅäÂ§©ËÆ∞ÂΩï</div>
                    <button class="new-chat-btn" @click="createNewChat">Êñ∞Âª∫</button>
                </div>
                <div class="history-list">
                    <div v-if="historyLoading" class="loading">
                        <div class="spinner"></div>
                        Âä†ËΩΩ‰∏≠...
                    </div>
                    <div v-else-if="groupedHistory.length === 0" class="empty-state">
                        <div class="empty-icon">üìù</div>
                        <div>ÊöÇÊó†ËÅäÂ§©ËÆ∞ÂΩï</div>
                    </div>
                    <div v-else>
                        <div v-for="group in groupedHistory" :key="group.title" class="history-group">
                            <div class="group-title">{{ group.title }}</div>
                            <div v-for="item in group.items" :key="item.session_id" class="history-item"
                                :class="{ active: currentSessionId === item.session_id }"
                                @click="loadHistorySession(item.session_id)">
                                <div class="history-abstract">{{ item.abstract }}</div>
                                <div class="history-time">{{ formatTime(item.update_time) }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    // Âü∫Á°ÄÊï∞ÊçÆ
                    userId: '',
                    currentSessionId: '',
                    inputMessage: '',
                    messages: [],
                    history: [],
                    isLoading: false,
                    historyLoading: false,

                    // ÈÄâÈ°πÈÖçÁΩÆ
                    storyOptions: ['A', 'B', 'C', 'D'],
                    selectedStoryType: 'x', // ÈªòËÆ§ÂÄº

                    // ËØ≠Èü≥ÂΩïÂà∂Áõ∏ÂÖ≥
                    isRecording: false,
                    voiceStatus: '',
                    mediaRecorder: null,
                    audioStream: null,
                    recordedChunks: [],
                    recordingSupported: false,

                    // APIÈÖçÁΩÆ
                    baseURL: 'http://localhost:8000',

                    // Èü≥È¢ëÊí≠ÊîæÁõ∏ÂÖ≥
                    audioEnabled: false,
                    audioContext: null
                };
            },
            computed: {
                groupedHistory() {
                    if (!this.history.length) return [];

                    const today = new Date().toDateString();
                    const todayItems = [];
                    const earlierItems = [];

                    this.history.forEach(item => {
                        const itemDate = new Date(item.update_time).toDateString();
                        if (itemDate === today) {
                            todayItems.push(item);
                        } else {
                            earlierItems.push(item);
                        }
                    });

                    const groups = [];
                    if (todayItems.length) {
                        groups.push({ title: '‰ªäÂ§©', items: todayItems });
                    }
                    if (earlierItems.length) {
                        groups.push({ title: 'Êõ¥Êó©', items: earlierItems });
                    }

                    return groups;
                }
            },
            async mounted() {
                await this.initializeUser();
                await this.loadHistory();
                this.setupBeforeUnload();
                this.initializeAudioRecording();
            },
            methods: {
                // ÂàùÂßãÂåñÁî®Êà∑
                async initializeUser() {
                    let userId = localStorage.getItem('userId');
                    console.log('‰ªélocalStorageËé∑ÂèñuserId:', userId);

                    if (!userId) {
                        try {
                            console.log('ÂàõÂª∫Êñ∞Áî®Êà∑...');
                            const response = await axios.get(`${this.baseURL}/create_user`);
                            userId = response.data.user_id;
                            this.currentSessionId = response.data.session_id;
                            localStorage.setItem('userId', userId);
                            console.log('Êñ∞Áî®Êà∑ÂàõÂª∫ÊàêÂäü - userId:', userId, 'sessionId:', this.currentSessionId);
                        } catch (error) {
                            console.error('ÂàõÂª∫Áî®Êà∑Â§±Ë¥•:', error);
                            alert('ÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
                            return;
                        }
                    }
                    this.userId = userId;
                    console.log('Áî®Êà∑ÂàùÂßãÂåñÂÆåÊàê - userId:', this.userId);
                },

                // Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩï
                async loadHistory() {
                    if (!this.userId) return;

                    this.historyLoading = true;
                    try {
                        const response = await axios.get(`${this.baseURL}/load_history?userid=${this.userId}`);
                        this.history = response.data.msg || [];
                    } catch (error) {
                        console.error('Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•:', error);
                    } finally {
                        this.historyLoading = false;
                    }
                },

                // Âä†ËΩΩÁâπÂÆö‰ºöËØù
                async loadHistorySession(sessionId) {
                    try {
                        const response = await axios.get(`${this.baseURL}/load_specific_session?userid=${this.userId}&sessionid=${sessionId}`);

                        const sessionData = response.data.msg[0];
                        this.currentSessionId = sessionId;

                        // ‰øùÂ≠òÂΩìÂâçsessionIdÂà∞localStorage
                        localStorage.setItem('currentSessionId', sessionId);

                        // Ëß£ÊûêÂéÜÂè≤Ê∂àÊÅØ
                        let historyMessages = [];
                        try {
                            historyMessages = JSON.parse(sessionData.history);
                        } catch (e) {
                            console.error('Ëß£ÊûêÂéÜÂè≤Ê∂àÊÅØÂ§±Ë¥•:', e);
                        }

                        // ËΩ¨Êç¢Ê∂àÊÅØÊ†ºÂºè
                        this.messages = historyMessages.map((msg, index) => ({
                            id: Date.now() + index,
                            type: msg.role === 'user' ? 'user' : 'system',
                            content: msg.content
                        }));

                        this.scrollToBottom();
                    } catch (error) {
                        console.error('Âä†ËΩΩ‰ºöËØùÂ§±Ë¥•:', error);
                        alert('Âä†ËΩΩ‰ºöËØùÂ§±Ë¥•');
                    }
                },

                // ÂàõÂª∫Êñ∞‰ºöËØù
                async createNewChat() {
                    try {
                        // Á°Æ‰øùÁî®Êà∑IDÂ≠òÂú®
                        if (!this.userId) {
                            await this.initializeUser();
                        }

                        console.log('ÂàõÂª∫Êñ∞‰ºöËØù - userId:', this.userId);
                        const response = await axios.get(`${this.baseURL}/chat/create_new_chat?userid=${this.userId}`);

                        this.currentSessionId = response.data.session_id;
                        console.log('Êñ∞‰ºöËØùÂàõÂª∫ÊàêÂäü - sessionId:', this.currentSessionId);

                        // ‰øùÂ≠òsessionIdÂà∞localStorage
                        localStorage.setItem('currentSessionId', this.currentSessionId);

                        this.messages = [];
                        this.selectedStoryType = 'x';
                        this.inputMessage = '';

                        // ÈáçÊñ∞Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩï
                        await this.loadHistory();
                    } catch (error) {
                        console.error('ÂàõÂª∫Êñ∞‰ºöËØùÂ§±Ë¥•:', error);
                        alert('ÂàõÂª∫Êñ∞‰ºöËØùÂ§±Ë¥•');
                    }
                },

                // ÂèëÈÄÅÊ∂àÊÅØ
                async sendMessage() {
                    if (!this.inputMessage.trim() || this.isLoading) return;

                    const userMessage = this.inputMessage.trim();
                    this.inputMessage = '';

                    // ÂêØÁî®Èü≥È¢ëÔºàÁî®Êà∑‰∫§‰∫íËß¶ÂèëÔºâ
                    await this.enableAudio();

                    // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
                    this.messages.push({
                        id: Date.now(),
                        type: 'user',
                        content: userMessage
                    });

                    this.scrollToBottom();
                    this.isLoading = true;

                    try {
                        // Á°Æ‰øùÁî®Êà∑IDÂ≠òÂú®
                        if (!this.userId) {
                            await this.initializeUser();
                        }

                        // Â¶ÇÊûúÊ≤°ÊúâÂΩìÂâç‰ºöËØùÔºåÂÖàÂàõÂª∫‰∏Ä‰∏™
                        if (!this.currentSessionId) {
                            await this.createNewChat();
                        }

                        // ÂÜçÊ¨°Á°ÆËÆ§Áî®Êà∑IDÂíå‰ºöËØùIDÈÉΩÂ≠òÂú®
                        if (!this.userId || !this.currentSessionId) {
                            throw new Error('Áî®Êà∑IDÊàñ‰ºöËØùID‰∏∫Á©∫');
                        }

                        console.log('ÂèëÈÄÅËÅäÂ§©ËØ∑Ê±Ç - userId:', this.userId, 'sessionId:', this.currentSessionId);

                        // Ë∞ÉÁî®ËÅäÂ§©Êé•Âè£
                        const encodedUserMsg = encodeURIComponent(userMessage);
                        const response = await axios.get(`${this.baseURL}/chat?userid=${this.userId}&sessionid=${this.currentSessionId}&user_msg=${encodedUserMsg}&story_type=${this.selectedStoryType}`);

                        // Ê∑ªÂä†Á≥ªÁªüÂõûÂ§çÔºå‰ΩøÁî®ÊâìÂ≠óÊú∫ÊïàÊûúÂíåËØ≠Èü≥Êí≠Êîæ
                        await this.addSystemMessageWithEffects(response.data.system_msg, response.data.audio_data, response.data.audio_duration);

                        // ÈáçÊñ∞Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩï
                        await this.loadHistory();

                    } catch (error) {
                        console.error('ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•:', error);
                        alert('ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');

                        // ÁßªÈô§Áî®Êà∑Ê∂àÊÅØ
                        this.messages.pop();
                    } finally {
                        this.isLoading = false;
                        this.scrollToBottom();
                        this.$refs.inputField.focus();
                    }
                },

                // Ê∏ÖÁ©∫ËÅäÂ§©
                clearChat() {
                    this.messages = [];
                },

                // ÂøòËÆ∞‰ºöËØù
                async forgetSession() {
                    if (!this.currentSessionId) return;

                    try {
                        await axios.get(`${this.baseURL}/chat/delete_session?user_id=${this.userId}&session_id=${this.currentSessionId}`);

                        this.messages = [];

                        // Ê∏ÖÁ©∫localStorage‰∏≠ÁöÑsessionId
                        localStorage.removeItem('currentSessionId');
                        this.currentSessionId = '';
                        this.selectedStoryType = 'x';

                        // ÈáçÊñ∞Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩï
                        await this.loadHistory();

                        alert('‰ºöËØùÂ∑≤Âà†Èô§');
                    } catch (error) {
                        console.error('Âà†Èô§‰ºöËØùÂ§±Ë¥•:', error);
                        alert('Âà†Èô§‰ºöËØùÂ§±Ë¥•');
                    }
                },

                // ÂàáÊç¢ÊïÖ‰∫ãÁ±ªÂûã
                toggleStoryType(option) {
                    if (this.selectedStoryType === option) {
                        this.selectedStoryType = 'x'; // ÂèñÊ∂àÈÄâ‰∏≠
                    } else {
                        this.selectedStoryType = option; // ÈÄâ‰∏≠
                    }
                },

                // Ëá™Âä®Ë∞ÉÊï¥ËæìÂÖ•Ê°ÜÈ´òÂ∫¶
                autoResize() {
                    const textarea = this.$refs.inputField;
                    textarea.style.height = 'auto';
                    textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
                },

                // ÊªöÂä®Âà∞Â∫ïÈÉ®
                scrollToBottom() {
                    this.$nextTick(() => {
                        const container = this.$refs.messagesContainer;
                        container.scrollTop = container.scrollHeight;
                    });
                },

                // Ê†ºÂºèÂåñÊó∂Èó¥
                formatTime(timeStr) {
                    const date = new Date(timeStr);
                    const now = new Date();
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

                    if (messageDate.getTime() === today.getTime()) {
                        return date.toLocaleTimeString('zh-CN', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    } else {
                        return date.toLocaleDateString('zh-CN', {
                            month: '2-digit',
                            day: '2-digit'
                        });
                    }
                },

                // ËÆæÁΩÆÈ°µÈù¢Á¶ªÂºÄ‰∫ã‰ª∂
                setupBeforeUnload() {
                    window.addEventListener('beforeunload', async (e) => {
                        if (this.userId) {
                            try {
                                // ‰ΩøÁî®fetchÂèëÈÄÅGETËØ∑Ê±ÇÔºåÁ°Æ‰øùÂú®È°µÈù¢Âç∏ËΩΩÊó∂‰πüËÉΩÂèëÈÄÅ
                                fetch(`${this.baseURL}/chat/save_usermsg?userid=${this.userId}`, {
                                    method: 'GET',
                                    keepalive: true
                                });
                            } catch (error) {
                                console.error('‰øùÂ≠òÁî®Êà∑Êï∞ÊçÆÂ§±Ë¥•:', error);
                            }
                        }
                    });
                },

                // ÂàùÂßãÂåñÈü≥È¢ëÂΩïÂà∂
                async initializeAudioRecording() {
                    // Ê£ÄÊü•ÊµèËßàÂô®ÊòØÂê¶ÊîØÊåÅMediaRecorder
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        console.warn('ÂΩìÂâçÊµèËßàÂô®‰∏çÊîØÊåÅÈü≥È¢ëÂΩïÂà∂ÂäüËÉΩ');
                        this.recordingSupported = false;
                        return;
                    }

                    // Ê£ÄÊü•HTTPSÂíåÊú¨Âú∞ÁéØÂ¢ÉÔºàÊîæÂÆΩÈôêÂà∂Ôºâ
                    if (location.protocol !== 'https:' &&
                        location.protocol !== 'http:' &&
                        location.hostname !== 'localhost' &&
                        location.hostname !== '127.0.0.1' &&
                        location.hostname !== '' &&
                        !location.hostname.includes('localhost')) {
                        console.warn('Èü≥È¢ëÂΩïÂà∂ÈúÄË¶ÅHTTPSÂçèËÆÆÊàñÊú¨Âú∞ÁéØÂ¢É');
                        this.recordingSupported = false;
                        return;
                    }

                    // ÂØπ‰∫éfile://ÂçèËÆÆÔºåÁªôÂá∫ÂèãÂ•ΩÊèêÁ§∫‰ΩÜ‰ªçÁÑ∂Â∞ùËØï
                    if (location.protocol === 'file:') {
                        console.warn('Âª∫ËÆÆ‰ΩøÁî®HTTPÊúçÂä°Âô®ËÆøÈóÆ‰ª•Ëé∑ÂæóÊúÄ‰Ω≥‰ΩìÈ™å');
                    }

                    try {
                        // ÊµãËØïÈ∫¶ÂÖãÈ£éÊùÉÈôê
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        stream.getTracks().forEach(track => track.stop()); // Á´ãÂç≥ÂÅúÊ≠¢ÊµãËØïÊµÅ

                        this.recordingSupported = true;
                        console.log('Èü≥È¢ëÂΩïÂà∂ÂäüËÉΩÂ∑≤ÂáÜÂ§áÂ∞±Áª™');
                    } catch (error) {
                        console.error('È∫¶ÂÖãÈ£éÊùÉÈôêËé∑ÂèñÂ§±Ë¥•:', error);
                        this.recordingSupported = false;

                        if (error.name === 'NotAllowedError') {
                            setTimeout(() => {
                                alert('È∫¶ÂÖãÈ£éÊùÉÈôêË¢´ÊãíÁªùÔºåËØ∑Âú®ÊµèËßàÂô®ËÆæÁΩÆ‰∏≠ÂÖÅËÆ∏È∫¶ÂÖãÈ£éÊùÉÈôêÂêéÂà∑Êñ∞È°µÈù¢');
                            }, 1000);
                        }
                    }
                },

                // ÂàáÊç¢Èü≥È¢ëÂΩïÂà∂Áä∂ÊÄÅ
                async toggleAudioRecording() {
                    if (!this.recordingSupported) {
                        alert('ÂΩìÂâçÊµèËßàÂô®‰∏çÊîØÊåÅÈü≥È¢ëÂΩïÂà∂ÂäüËÉΩÔºåËØ∑‰ΩøÁî®Chrome„ÄÅEdgeÊàñÂÖ∂‰ªñÊîØÊåÅÁöÑÊµèËßàÂô®');
                        return;
                    }

                    if (this.isRecording) {
                        // ÂÅúÊ≠¢ÂΩïÈü≥
                        await this.stopRecording();
                    } else {
                        // ÂºÄÂßãÂΩïÈü≥
                        await this.startRecording();
                    }
                },

                // ÂºÄÂßãÂΩïÈü≥
                async startRecording() {
                    try {
                        this.voiceStatus = 'Ê≠£Âú®ÂºÄÂßãÂΩïÈü≥...';

                        // Ëé∑ÂèñÈü≥È¢ëÊµÅ
                        this.audioStream = await navigator.mediaDevices.getUserMedia({
                            audio: {
                                echoCancellation: true,
                                noiseSuppression: true,
                                sampleRate: 44100
                            }
                        });

                        // ÂàõÂª∫MediaRecorder
                        this.mediaRecorder = new MediaRecorder(this.audioStream, {
                            mimeType: 'audio/webm'
                        });

                        this.recordedChunks = [];

                        // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
                        this.mediaRecorder.ondataavailable = (event) => {
                            if (event.data.size > 0) {
                                this.recordedChunks.push(event.data);
                            }
                        };

                        this.mediaRecorder.onstop = async () => {
                            this.voiceStatus = 'ÂΩïÈü≥ÂÆåÊàêÔºåÊ≠£Âú®‰∏ä‰º†...';
                            await this.uploadAudio();
                        };

                        // ÂºÄÂßãÂΩïÈü≥
                        this.mediaRecorder.start();
                        this.isRecording = true;
                        this.voiceStatus = 'Ê≠£Âú®ÂΩïÈü≥‰∏≠...';

                        console.log('ÂºÄÂßãÂΩïÈü≥');
                    } catch (error) {
                        console.error('ÂºÄÂßãÂΩïÈü≥Â§±Ë¥•:', error);
                        this.voiceStatus = 'ÂΩïÈü≥Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•È∫¶ÂÖãÈ£éÊùÉÈôê';

                        setTimeout(() => {
                            this.voiceStatus = '';
                        }, 3000);
                    }
                },

                // ÂÅúÊ≠¢ÂΩïÈü≥
                async stopRecording() {
                    if (this.mediaRecorder && this.mediaRecorder.state === 'recording') {
                        this.mediaRecorder.stop();
                        this.isRecording = false;
                        this.voiceStatus = 'Ê≠£Âú®Â§ÑÁêÜÂΩïÈü≥...';

                        // ÂÅúÊ≠¢Èü≥È¢ëÊµÅ
                        if (this.audioStream) {
                            this.audioStream.getTracks().forEach(track => track.stop());
                        }

                        console.log('ÂÅúÊ≠¢ÂΩïÈü≥');
                    }
                },

                // ‰∏ä‰º†Èü≥È¢ëÂà∞ÂêéÁ´ØÂπ∂ËøõË°åËØ≠Èü≥ËØÜÂà´
                async uploadAudio() {
                    try {
                        if (this.recordedChunks.length === 0) {
                            this.voiceStatus = 'Ê≤°ÊúâÂΩïÈü≥Êï∞ÊçÆ';
                            return;
                        }

                        // Á°Æ‰øùÊúâsessionId
                        await this.ensureSessionId();

                        this.voiceStatus = 'Ê≠£Âú®ËøõË°åËØ≠Èü≥ËØÜÂà´...';

                        // ÂàõÂª∫Èü≥È¢ëBlob
                        const audioBlob = new Blob(this.recordedChunks, { type: 'audio/webm' });

                        // ÂàõÂª∫FormData
                        const formData = new FormData();
                        formData.append('audio', audioBlob, `recording_${Date.now()}.webm`);
                        formData.append('user_id', this.userId);
                        formData.append('session_id', this.currentSessionId);
                        formData.append('story_type', this.selectedStoryType);

                        // ÂèëÈÄÅÂà∞ÂêéÁ´ØËøõË°åËØ≠Èü≥ËØÜÂà´ÂíåAIÂõûÂ§ç
                        const response = await fetch(`${this.baseURL}/upload_audio`, {
                            method: 'POST',
                            body: formData
                        });

                        if (response.ok) {
                            const result = await response.json();

                            if (result.recognized_text) {
                                // Ê∑ªÂä†Áî®Êà∑ËØ≠Èü≥Ê∂àÊÅØÔºàÊòæÁ§∫ËØÜÂà´ÁöÑÊñáÂ≠óÔºâ
                                this.messages.push({
                                    id: Date.now(),
                                    type: 'user',
                                    content: `üé§ ${result.recognized_text}`
                                });

                                // Ê∑ªÂä†AIÂõûÂ§çÔºå‰ΩøÁî®ÊâìÂ≠óÊú∫ÊïàÊûúÂíåËØ≠Èü≥Êí≠Êîæ
                                if (result.ai_response) {
                                    await this.addSystemMessageWithEffects(
                                        result.ai_response,
                                        result.ai_audio_data,
                                        result.ai_audio_duration
                                    );
                                }

                                this.voiceStatus = 'ËØ≠Èü≥ËØÜÂà´ÂÆåÊàê';
                                console.log('ËØ≠Èü≥ËØÜÂà´ÁªìÊûú:', result.recognized_text);

                                // ÈáçÊñ∞Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩï
                                await this.loadHistory();
                            } else {
                                this.voiceStatus = 'ËØ≠Èü≥ËØÜÂà´Â§±Ë¥•';
                            }
                        } else {
                            throw new Error('ËØ≠Èü≥Â§ÑÁêÜÂ§±Ë¥•');
                        }
                    } catch (error) {
                        console.error('ËØ≠Èü≥Â§ÑÁêÜÂ§±Ë¥•:', error);
                        this.voiceStatus = 'ËØ≠Èü≥Â§ÑÁêÜÂ§±Ë¥•ÔºåËØ∑ÈáçËØï';
                    }

                    setTimeout(() => {
                        this.voiceStatus = '';
                        this.scrollToBottom();
                    }, 3000);
                },

                // Á°Æ‰øùÊúâsessionId
                async ensureSessionId() {
                    if (!this.currentSessionId) {
                        // Ê£ÄÊü•localStorage
                        const storedSessionId = localStorage.getItem('currentSessionId');
                        if (storedSessionId) {
                            this.currentSessionId = storedSessionId;
                        } else {
                            // ÂàõÂª∫Êñ∞‰ºöËØù
                            await this.createNewChat();
                        }
                    }
                },

                // Ê∑ªÂä†Á≥ªÁªüÊ∂àÊÅØÂπ∂Êí≠ÊîæÊâìÂ≠óÊú∫ÊïàÊûúÂíåËØ≠Èü≥
                async addSystemMessageWithEffects(messageText, audioData, audioDuration) {
                    if (!messageText) return;

                    // Ê∑ªÂä†Á©∫ÁöÑÁ≥ªÁªüÊ∂àÊÅØ
                    const messageId = Date.now() + 1;
                    this.messages.push({
                        id: messageId,
                        type: 'system',
                        content: '',
                        isTyping: true
                    });

                    this.scrollToBottom();

                    // ÂêåÊó∂ÂêØÂä®ËØ≠Èü≥Êí≠ÊîæÂíåÊâìÂ≠óÊú∫ÊïàÊûú
                    const audioPromise = this.startAudioPlayback(audioData);
                    const typingPromise = this.typewriterEffect(messageId, messageText, audioDuration || 3);

                    // Á≠âÂæÖ‰∏§‰∏™ÊïàÊûúÈÉΩÂÆåÊàê
                    await Promise.allSettled([audioPromise, typingPromise]);

                    // Ê†áËÆ∞ÊâìÂ≠óÂÆåÊàê
                    const messageIndex = this.messages.findIndex(msg => msg.id === messageId);
                    if (messageIndex !== -1) {
                        this.messages[messageIndex].isTyping = false;
                    }
                },

                // ÂêØÂä®Èü≥È¢ëÊí≠ÊîæÔºàÈùûÈòªÂ°ûÔºâ
                async startAudioPlayback(audioData) {
                    if (!audioData) {
                        console.log('Ê≤°ÊúâÈü≥È¢ëÊï∞ÊçÆÔºåË∑≥ËøáÊí≠Êîæ');
                        return;
                    }

                    // Ê£ÄÊü•Èü≥È¢ëÊï∞ÊçÆÊòØÂê¶‰∏∫Á©∫Â≠óÁ¨¶‰∏≤
                    if (audioData === '') {
                        console.log('Èü≥È¢ëÊï∞ÊçÆ‰∏∫Á©∫ÔºåË∑≥ËøáÊí≠Êîæ');
                        return;
                    }

                    // È¶ñÊ¨°Êí≠ÊîæÊó∂Â∞ùËØïÂêØÁî®Èü≥È¢ë
                    if (!this.audioEnabled) {
                        await this.enableAudio();
                    }

                    try {
                        console.log('ÂáÜÂ§áÊí≠ÊîæÈü≥È¢ëÔºåÊï∞ÊçÆÈïøÂ∫¶:', audioData.length);
                        const audioElement = await this.playAudioFromBase64(audioData);
                        if (audioElement) {
                            console.log('ËØ≠Èü≥Êí≠ÊîæÂ∑≤ÂêØÂä®');
                        } else {
                            console.log('ËØ≠Èü≥Êí≠ÊîæË¢´Ë∑≥ËøáÔºàÂèØËÉΩÁî±‰∫éÊµèËßàÂô®ÈôêÂà∂Ôºâ');
                        }
                    } catch (error) {
                        console.warn('ËØ≠Èü≥Êí≠ÊîæÂ§±Ë¥•Ôºå‰ΩÜ‰∏çÂΩ±ÂìçÊñáÂ≠óÊòæÁ§∫:', error.message);
                    }
                },

                // ÂêØÁî®Èü≥È¢ëÊí≠ÊîæÔºàÈÄöËøáÁî®Êà∑‰∫§‰∫íÔºâ
                async enableAudio() {
                    if (this.audioEnabled) return;

                    try {
                        // ÂàõÂª∫‰∏Ä‰∏™Áü≠ÊöÇÁöÑÈü≥È¢ë‰∏ä‰∏ãÊñáÊù•"Ëß£ÈîÅ"Èü≥È¢ëÊí≠Êîæ
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();

                        // Êí≠Êîæ‰∏Ä‰∏™ÈùôÈü≥ÁöÑÁü≠Èü≥È¢ëÊù•ÂêØÁî®Èü≥È¢ë
                        const buffer = this.audioContext.createBuffer(1, 1, 22050);
                        const source = this.audioContext.createBufferSource();
                        source.buffer = buffer;
                        source.connect(this.audioContext.destination);
                        source.start();

                        this.audioEnabled = true;
                        console.log('Èü≥È¢ëÊí≠ÊîæÂ∑≤ÂêØÁî®');
                    } catch (error) {
                        console.warn('Êó†Ê≥ïÂêØÁî®Èü≥È¢ëÊí≠Êîæ:', error);
                    }
                },

                // ÊâìÂ≠óÊú∫ÊïàÊûú
                async typewriterEffect(messageId, fullText, duration) {
                    const messageIndex = this.messages.findIndex(msg => msg.id === messageId);
                    if (messageIndex === -1) return;

                    const chars = Array.from(fullText); // ÊîØÊåÅUnicodeÂ≠óÁ¨¶
                    const totalChars = chars.length;
                    const interval = Math.max(50, (duration * 1000) / totalChars); // ÊúÄÂ∞è50msÈó¥Èöî

                    for (let i = 0; i <= totalChars; i++) {
                        if (messageIndex >= 0 && messageIndex < this.messages.length) {
                            this.messages[messageIndex].content = chars.slice(0, i).join('');
                            this.scrollToBottom();
                        }

                        if (i < totalChars) {
                            await new Promise(resolve => setTimeout(resolve, interval));
                        }
                    }
                },

                // ‰ªéBase64Êí≠ÊîæÈü≥È¢ë
                async playAudioFromBase64(base64Data) {
                    return new Promise((resolve, reject) => {
                        try {
                            // Ê£ÄÊµãÈü≥È¢ëÊ†ºÂºè
                            const mimeType = this.detectAudioMimeType(base64Data);
                            console.log('Ê£ÄÊµãÂà∞Èü≥È¢ëÊ†ºÂºè:', mimeType);

                            // ÂàõÂª∫Èü≥È¢ëURL
                            const audioBlob = this.base64ToBlob(base64Data, mimeType);

                            if (audioBlob.size === 0) {
                                console.warn('Èü≥È¢ëÊï∞ÊçÆ‰∏∫Á©∫');
                                resolve(null);
                                return;
                            }

                            console.log('Èü≥È¢ëBlobÂ§ßÂ∞è:', audioBlob.size, 'Â≠óËäÇ');
                            const audioUrl = URL.createObjectURL(audioBlob);

                            // ÂàõÂª∫Èü≥È¢ëÂÖÉÁ¥†
                            const audio = new Audio(audioUrl);

                            // ËÆæÁΩÆÈü≥È¢ëÂ±ûÊÄß
                            audio.preload = 'auto';
                            audio.volume = 0.8;

                            let isResolved = false;

                            // Èü≥È¢ëÂèØ‰ª•Êí≠ÊîæÊó∂
                            audio.oncanplaythrough = () => {
                                if (!isResolved) {
                                    console.log('Èü≥È¢ëÂáÜÂ§áÂ∞±Áª™ÔºåÂºÄÂßãÊí≠Êîæ');

                                    // ‰ΩøÁî®Áî®Êà∑‰∫§‰∫íËß¶ÂèëÊí≠ÊîæÔºàÈÅøÂÖçËá™Âä®Êí≠ÊîæÈôêÂà∂Ôºâ
                                    const playPromise = audio.play();

                                    if (playPromise !== undefined) {
                                        playPromise.then(() => {
                                            if (!isResolved) {
                                                isResolved = true;
                                                resolve(audio);
                                            }
                                        }).catch((error) => {
                                            if (!isResolved) {
                                                isResolved = true;
                                                // Ê†πÊçÆÈîôËØØÁ±ªÂûãËøõË°å‰∏çÂêåÂ§ÑÁêÜ
                                                if (error.name === 'NotAllowedError') {
                                                    console.warn('Èü≥È¢ëËá™Âä®Êí≠ÊîæË¢´ÈòªÊ≠¢ÔºåÈúÄË¶ÅÁî®Êà∑‰∫§‰∫í');
                                                    resolve(null);
                                                } else if (error.name === 'AbortError') {
                                                    console.warn('Èü≥È¢ëÊí≠ÊîæË¢´‰∏≠Êñ≠ÔºåÂèØËÉΩÊòØÂø´ÈÄüÂàáÊç¢ÂØºËá¥');
                                                    resolve(null);
                                                } else if (error.name === 'NotSupportedError') {
                                                    console.warn('Èü≥È¢ëÊ†ºÂºè‰∏çÊîØÊåÅ');
                                                    resolve(null);
                                                } else {
                                                    console.error('Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•:', error);
                                                    resolve(null); // Êîπ‰∏∫resolveËÄå‰∏çÊòØrejectÔºåÈÅøÂÖçÈòªÊñ≠ÊµÅÁ®ã
                                                }
                                            }
                                        });
                                    } else {
                                        // ÊóßÊµèËßàÂô®ÂÖºÂÆπ
                                        if (!isResolved) {
                                            isResolved = true;
                                            resolve(audio);
                                        }
                                    }
                                }
                            };

                            // Èü≥È¢ëÂä†ËΩΩÈîôËØØ
                            audio.onerror = (error) => {
                                if (!isResolved) {
                                    isResolved = true;
                                    console.error('Èü≥È¢ëÂä†ËΩΩÈîôËØØ:', error);
                                    URL.revokeObjectURL(audioUrl);
                                    reject(error);
                                }
                            };

                            // Èü≥È¢ëÊí≠ÊîæÁªìÊùü
                            audio.onended = () => {
                                URL.revokeObjectURL(audioUrl);
                                console.log('Èü≥È¢ëÊí≠ÊîæÂÆåÊàê');
                            };

                            // Èü≥È¢ë‰∏≠Ê≠¢
                            audio.onabort = () => {
                                URL.revokeObjectURL(audioUrl);
                                console.log('Èü≥È¢ëÊí≠ÊîæË¢´‰∏≠Ê≠¢');
                            };

                            // ËÆæÁΩÆË∂ÖÊó∂Â§ÑÁêÜ
                            setTimeout(() => {
                                if (!isResolved) {
                                    isResolved = true;
                                    console.warn('Èü≥È¢ëÂä†ËΩΩË∂ÖÊó∂ÔºåÁªßÁª≠ÊâßË°å');
                                    resolve(null);
                                }
                            }, 3000); // 3ÁßíË∂ÖÊó∂

                        } catch (error) {
                            reject(error);
                        }
                    });
                },

                // Base64ËΩ¨Blob
                base64ToBlob(base64, mimeType) {
                    try {
                        const byteCharacters = atob(base64);
                        const byteNumbers = new Array(byteCharacters.length);

                        for (let i = 0; i < byteCharacters.length; i++) {
                            byteNumbers[i] = byteCharacters.charCodeAt(i);
                        }

                        const byteArray = new Uint8Array(byteNumbers);
                        return new Blob([byteArray], { type: mimeType });
                    } catch (error) {
                        console.error('Base64Ëß£Á†ÅÂ§±Ë¥•:', error);
                        return new Blob([], { type: mimeType });
                    }
                },

                // Ê£ÄÊµãÈü≥È¢ëÊ†ºÂºè
                detectAudioMimeType(base64Data) {
                    try {
                        // Ëß£Á†ÅÂâçÂá†‰∏™Â≠óËäÇÊù•Ê£ÄÊµãÊñá‰ª∂Á±ªÂûã
                        const header = atob(base64Data.substring(0, 20));

                        // WAVÊñá‰ª∂Â§¥
                        if (header.startsWith('RIFF') && header.includes('WAVE')) {
                            return 'audio/wav';
                        }
                        // MP3Êñá‰ª∂Â§¥
                        else if (header.charCodeAt(0) === 0xFF && (header.charCodeAt(1) & 0xE0) === 0xE0) {
                            return 'audio/mpeg';
                        }
                        // OGGÊñá‰ª∂Â§¥
                        else if (header.startsWith('OggS')) {
                            return 'audio/ogg';
                        }
                        // WebMÊñá‰ª∂Â§¥
                        else if (header.includes('webm')) {
                            return 'audio/webm';
                        }
                        // ÈªòËÆ§‰ΩøÁî®WAV
                        else {
                            console.warn('Êó†Ê≥ïËØÜÂà´Èü≥È¢ëÊ†ºÂºèÔºå‰ΩøÁî®ÈªòËÆ§WAVÊ†ºÂºè');
                            return 'audio/wav';
                        }
                    } catch (error) {
                        console.error('Èü≥È¢ëÊ†ºÂºèÊ£ÄÊµãÂ§±Ë¥•:', error);
                        return 'audio/wav';
                    }
                },


            }
        }).mount('#app');
    </script>
</body>

</html>